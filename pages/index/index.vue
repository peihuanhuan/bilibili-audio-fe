<template>
	<view>
		<uni-card class="example-body" :isFull="true">
			<text style="font-weight:blod">è¯´æ˜ï¼š\n\n</text>
			<text>1. è¾“å…¥åˆ†äº«é“¾æ¥ã€æˆ–å®Œæ•´è§†é¢‘é“¾æ¥å³å¯ã€‚å¤šä¸ªè§†é¢‘ï¼Œé“¾æ¥é—´æ¢è¡Œå³å¯ã€‚\n\n</text>
			<text>2. ä»»åŠ¡å®Œæˆåï¼Œä¼šæœ‰æœåŠ¡é€šçŸ¥æé†’ã€‚ç”±äºé•¿åº¦é™åˆ¶ï¼Œéœ€è¦è¿›å…¥å…¬ä¼—å·å›å¤ã€éŸ³é¢‘ã€‘ä¸¤å­—è·å–ä¸‹è½½é“¾æ¥ã€‚ç‚¹å‡»æœåŠ¡é€šçŸ¥å³å¯è¿›å…¥å…¬ä¼—å·ã€‚\n\n</text>
			<text>3. é•¿æ—¶é—´æœªå®Œæˆï¼Œæ›´å¤šéœ€æ±‚æˆ–æ„è§ï¼Œç›´æ¥åœ¨å…¬ä¼—å·å†…ç•™è¨€ã€‚</text>
			<br></br>
			<el-input type="textarea" :autosize="{ minRows: 16, maxRows: 40}" placeholder="è¿™æ˜¯ä¸ªğŸŒ° æœ‰å…¶ä»–å†…å®¹éƒ½èƒ½è§£æåˆ°~
			
ã€ã€ç«¹ç¬›ã€‘å·¦æ‰‹æŒ‡æœˆ æ¥äº†ï¼ŒæŒ‘æˆ˜ç¬›å­éŸ³åŸŸæé™ ã€Šé¦™èœœæ²‰æ²‰çƒ¬å¦‚éœœã€‹ç‰‡å°¾æ›² ä¸å¥½å¬ã€‚ã€‚ã€‚ UPä¸»å»è·³å…”å­èˆï¼-å“”å“©å“”å“©ã€‘ https://b23.tv/W3i97LU

ç¬¬äºŒä¸ªè§†é¢‘ğŸ‘‡ğŸ‘‡ğŸ‘‡
https://www.bilibili.com/video/BV19T4y1c7op?from=search&seid=12490260815654528041
 
ä¸€æ¬¡æœ€å¤šäº”ä¸ªè§†é¢‘!" v-model="value">
			</el-input>
			
			<div style="text-align:center; padding-top: 30px; padding-bottom: 200px;">
			<wx-open-subscribe template="fz7qD2rvdF8-NVCKDyetJkga2zJC4APH1PnY7lZKD9Y" v-pre id="subscribe-btn">
				<script type="text/wxtag-template" slot="style">
					<style>
					  .subscribe-btn {
						width:300px;
						height: 45px;
						border-radius: 4px;
						margin:0 auto;
						color: #fff;
					    text-align: center;
					    border: none;
						background-color: #07c160;
					  }
					</style>
				</script>
				<script type="text/wxtag-template">
					<!-- <el-button type="primary" class="subscribe-btn">æäº¤å¿ƒæ„¿å•</el-button> -->
					<button class="subscribe-btn">æäº¤å¿ƒæ„¿å•</button>
				</script>
			</wx-open-subscribe>
			</div>



		</uni-card>


	</view>
</template>

<script>
	var jweixin = require('jweixin-module')

	export default {
		data() {
			return {
				value: '',
				code: ''
			}
		},
		mounted() {
			var btn = document.getElementById('subscribe-btn');
			btn.addEventListener('success', this.submita);
			btn.addEventListener('error', function(e) {
				console.log('å¤±è´¥äº† ', e.detail);
			});
		},

		onLoad() {

			let url = window.encodeURIComponent(location.href.split('#')[0])

			var requestUrl =
				`wx/${process.uniEnv.VUE_APP_WX_APPID}/user/jsapiSignature?url=${url}`
			this.$ajax.get(requestUrl).then((response) => {
				jweixin.config({
					debug: false, //æ˜¯å¦å¼€å¯debug
					appId: process.uniEnv.VUE_APP_WX_APPID, //å¿…å¡«ï¼Œå…¬ä¼—å·çš„å”¯ä¸€æ ‡è¯†
					timestamp: response.data.timestamp, // å¿…å¡«ï¼Œç”Ÿæˆç­¾åçš„æ—¶é—´æˆ³
					nonceStr: response.data.nonceStr, // å¿…å¡«ï¼Œç”Ÿæˆç­¾åçš„éšæœºä¸²
					signature: response.data.signature, // å¿…å¡«ï¼Œç­¾å
					jsApiList: ['wx-open-subscribe', 'wx-open-launch-app', 'launchAppLication'],
					openTagList: ['wx-open-subscribe', 'wx-open-launch-app', 'wx-open-subscribe-dialog']
				});
			}).catch((e) => {

			})

			jweixin.ready(() => {
				console.log("ready");
				//configä¿¡æ¯éªŒè¯åä¼šæ‰§è¡Œreadyæ–¹æ³•ï¼Œæ‰€æœ‰æ¥å£è°ƒç”¨éƒ½å¿…é¡»åœ¨configæ¥å£è·å¾—ç»“æœä¹‹åï¼Œconfigæ˜¯ä¸€ä¸ªå®¢æˆ·ç«¯çš„å¼‚æ­¥æ“ä½œï¼Œæ‰€ä»¥å¦‚æœéœ€è¦åœ¨é¡µé¢åŠ è½½æ—¶å°±è°ƒç”¨ç›¸å…³æ¥å£ï¼Œåˆ™é¡»æŠŠç›¸å…³æ¥å£æ”¾åœ¨readyå‡½æ•°ä¸­è°ƒç”¨æ¥ç¡®ä¿æ­£ç¡®æ‰§è¡Œã€‚å¯¹äºç”¨æˆ·è§¦å‘æ—¶æ‰è°ƒç”¨çš„æ¥å£ï¼Œåˆ™å¯ä»¥ç›´æ¥è°ƒç”¨ï¼Œä¸éœ€è¦æ”¾åœ¨readyå‡½æ•°ä¸­
			});
			jweixin.error(res => {
				console.info("å¼€å§‹error", res);
				// configä¿¡æ¯éªŒè¯å¤±è´¥ä¼šæ‰§è¡Œerrorå‡½æ•°ï¼Œå¦‚ç­¾åè¿‡æœŸå¯¼è‡´éªŒè¯å¤±è´¥ï¼Œå…·ä½“é”™è¯¯ä¿¡æ¯å¯ä»¥æ‰“å¼€configçš„debugæ¨¡å¼æŸ¥çœ‹ï¼Œä¹Ÿå¯ä»¥åœ¨è¿”å›çš„reså‚æ•°ä¸­æŸ¥çœ‹ï¼Œå¯¹äºSPAå¯ä»¥åœ¨è¿™é‡Œæ›´æ–°ç­¾å
			});




			var token = this.$cookies.get("token")
			if (token != null) {
				return;
			}

			this.code = this.getUrlParam("code")
			if (this.code == null) {
				this.jumpAuthUrl()
			} else {
				this.login()
			}


		},
		methods: {
			submita(e) {
				let subscribeDetails = JSON.parse(e.detail.subscribeDetails); // å…¨éƒ¨çš„æ¨¡æ¿
							
				console.log(e.detail)
				let subKey = subscribeDetails['fz7qD2rvdF8-NVCKDyetJkga2zJC4APH1PnY7lZKD9Y']; // è·å–æ¯ä¸ªæ¨¡æ¿çš„çŠ¶æ€
				console.log('subkey')
				console.log(subKey)
				let status = JSON.parse(subKey);
				console.log(`status: ${status}`)
				if(status.status == 'accept') {
					this.$message.info({message: 'æ­£åœ¨è§£æä»»åŠ¡ä¸­ï¼Œè¯·ç¨åï¼', duration:8000});
					this.$ajax.post({url: 'bilibili/audio', data: {"data": this.value}}).then((response) => {
						console.log("è¯·æ±‚ä»»åŠ¡", response)
						if (response.data != null) {
							this.value = ''
							this.$message.success({message: `è§£æåˆ°${response.data}ä¸ªè§†é¢‘ï¼Œå¼€å§‹å¤„ç†ï¼è¯·å…³æ³¨æœåŠ¡é€šçŸ¥`, duration:8000});
						} else {
							this.$message.error(response.msg);
						}
					}).catch((e) => {
					
					})

				}
			},
			jumpAuthUrl() {
				
				console.log(window.location.href)
				var url =
					`wx/${process.uniEnv.VUE_APP_WX_APPID}/user/authorizationUrl?scope=snsapi_userinfo&redirectUri=${window.location.href}`
					
				console.log(url)
				this.$ajax.get(url).then((response) => {
					console.log("è·å–æˆæƒé“¾æ¥", response)
					if (response.data != null) {
						window.location.href = response.data
					} else {
						this.$message.error('æœåŠ¡å™¨å¼€å°å·®äº†ï¼Œè¯·åœ¨å…¬ä¼—å·è”ç³»å¼€å‘è€…');
					}
				}).catch((e) => {

				})
			},
			login() {
				this.$ajax.post(
					`wx/${process.uniEnv.VUE_APP_WX_APPID}/user/login?code=${this.code}`
				).then((response) => {
					this.$cookies.set("token", response.data, '7d')
				})
			},
			getUrlParam(name) {
				var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
				var r = window.location.search.substr(1).match(reg);
				if (r != null) {
					return decodeURIComponent(r[2]);
				}
				return null; //è¿”å›å‚æ•°å€¼
			},
		}
	}
</script>
<style>
	/* å¤´æ¡å°ç¨‹åºç»„ä»¶å†…ä¸èƒ½å¼•å…¥å­—ä½“ */
	/* #ifdef MP-TOUTIAO */
	@font-face {
		font-family: uniicons;
		font-weight: normal;
		font-style: normal;
		src: url("~@/static/uni.ttf") format("truetype");
	}

	/* #endif */
	/* #ifndef APP-NVUE */
	page {
		display: flex;
		flex-direction: column;
		box-sizing: border-box;
		background-color: #efeff4;
		min-height: 100%;
		height: auto;
	}



	view {
		font-size: 14px;
		line-height: inherit;
	}

	.example {
		padding: 0 15px 15px;
	}

	.example-info {
		padding: 15px;
		color: #3b4144;
		background: #ffffff;
	}

	.example-body {
		/* #ifndef APP-NVUE */
		display: flex;
		/* #endif */
		flex-direction: row;
		flex-wrap: wrap;
		justify-content: center;
		padding: 0;
		font-size: 14px;
		background-color: #ffffff;
	}

	/* #endif */
	.example {
		padding: 0 15px;
	}

	.example-info {
		/* #ifndef APP-NVUE */
		display: block;
		/* #endif */
		padding: 15px;
		color: #3b4144;
		background-color: #ffffff;
		font-size: 14px;
		line-height: 20px;
	}

	.example-info-text {
		font-size: 14px;
		line-height: 20px;
		color: #3b4144;
	}

	.example-body {
		flex-direction: column;
		padding: 15px;
		background-color: #ffffff;
	}

	.word-btn-white {
		font-size: 18px;
		color: #FFFFFF;
	}

	.word-btn {
		/* #ifndef APP-NVUE */
		display: flex;
		/* #endif */
		flex-direction: row;
		align-items: center;
		justify-content: center;
		border-radius: 6px;
		height: 48px;
		margin: 15px;
		background-color: #007AFF;
	}

	.word-btn--hover {
		background-color: #4ca2ff;
	}

	.example-body {
		/* #ifndef APP-NVUE */
		display: block;
		/* #endif */
		padding: 1px 0;
	}

	.example-box {
		margin: 12px 0;
	}

	.image-box {
		/* #ifndef APP-NVUE */
		display: flex;
		flex-direction: column;
		/* #endif */
		height: 350rpx;
		overflow: hidden;
	}

	.image {
		/* #ifndef APP-NVUE */
		width: 100%;
		height: 100%;
		/* #endif */
		flex: 1;
	}

	.content-box {
		padding-top: 20rpx;
	}

	.content-box-text {
		font-size: 12px;
		line-height: 22px;
	}

	.footer-box {
		/* #ifndef APP-NVUE */
		display: flex;
		/* #endif */
		justify-content: space-between;
		flex-direction: row;
	}

	.footer-box__item {
		align-items: center;
		padding: 2px 0;
		font-size: 12px;
		color: #666;
	}
</style>
